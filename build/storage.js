// Generated by CoffeeScript 2.4.1
(function() {
  // Lounge browser storage. Load and save documents to lounge storage. Saved
  // documents will checkpoint as you type.
  'use strict';
  define(['./org', './docOrg', './utilities', './db', './editorSupport'], function(Org, DocOrg, Utilites, EditorSupport) {
    var LocalDoc, clearIndices, getDocument, initStorage, parseOrgDoc, storeDocument, storeNameFor;
    ({parseOrgDoc} = EditorSupport);
    clearIndices = true;
    initStorage = function() {};
    storeNameFor = function(docName) {
      return `@local ${docName}`;
    };
    getDocument = function(docName) {
      var blocks, t;
      t = transaction(storeNameFor(docName), 'readonly');
      blocks = null;
      return t.getAll('ids').then(function(rawBlocks) {
        blocks = _.keyBy(rawBlocks, '_id');
        return t.get('first').then(function(first) {
          return {first, blocks};
        });
      });
    };
    storeDocument = function(data, docName, first, blocks) {
      var sets;
      if (!blocks) {
        blocks = parseOrgMode(first);
        first = blocks[0]._id;
        sets = _.keyBy(blocks, '_id');
        data.linkAllSiblings({first, sets});
      }
      return transaction(storeNameFor(docName)).then(function(t) {
        var block, i, index, j, len, len1, ref;
        if (clearIndices) {
          ref = t.store.indexNames;
          for (i = 0, len = ref.length; i < len; i++) {
            index = ref[i];
            store.deleteIndex(index);
          }
        }
        if (!store.indexNames.length) {
          store.createIndex('ids', '_id', {
            unique: true
          });
          store.createIndex('names', 'codeName');
        }
        t.put(first, 'first');
        for (j = 0, len1 = blocks.length; j < len1; j++) {
          block = blocks[j];
          t.put(block, block._id);
        }
        return null;
      });
    };
    LocalDoc = class LocalDoc {
      constructor(data) {
        this.clear = this.clear.bind(this);
        this.storeName = storeNameFor(data.baseDocName);
        data.addFilter;
      }

      transaction(type) {
        return transaction(this.storeName, type);
      }

      replaceBlock(data, oldBlock, newBlock, context) {
        return this.transaction().put(newBlock, newBlock._id);
      }

      clear(data) {
        return this.transaction().clear();
      }

    };
    return {initStorage};
  });

}).call(this);

//# sourceMappingURL=storage.js.map
