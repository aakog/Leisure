// Generated by CoffeeScript 2.4.1
(function() {
  'use strict';
  define(['./editor', './editorSupport', './ui', './modes'], function(Editor, EditorSupport, UI, Modes) {
    var LeisureEditCore, OrgEditing, SearchEditor, addController, addSearchDataFilter, addView, basicDataFilter, chr, configureSearch, doSlideValue, editorCount, editorForToolbar, fancyMode, findEditor, grams, hasView, indexQuery, initializePendingViews, mergeContext, normalize, openSearch, preserveSelection, removeController, removeView, renderView, searchForBlocks, searchToken, tokenize, viewKey, withContext;
    ({findEditor, LeisureEditCore, preserveSelection} = Editor);
    ({OrgEditing, editorForToolbar, basicDataFilter} = EditorSupport);
    ({fancyMode, doSlideValue} = Modes);
    ({addView, removeView, renderView, hasView, viewKey, addController, removeController, withContext, mergeContext, initializePendingViews} = UI);
    searchToken = /[^\'\"]+|\'[^\']*\'|\"[^\"]*\"/g;
    editorCount = 0;
    normalize = function(str) {
      return str && str.toLowerCase().replace(/([^a-z0-9]|\n)+/g, '').trim();
    };
    chr = function(c) {
      return c.charCodeAt(0);
    };
    grams = function(str, gr = {}) {
      var c, cc, i, j, k, l, len, ref, ref1, ref2, ref3, ref4, ref5, ref6;
      str = normalize(str);
      if (str) {
        ref4 = (function() {
          var results1 = [];
          for (var k = ref2 = chr('a'), ref3 = chr('z'); ref2 <= ref3 ? k <= ref3 : k >= ref3; ref2 <= ref3 ? k++ : k--){ results1.push(k); }
          return results1;
        }).apply(this).concat((function() {
          var results1 = [];
          for (var k = ref = chr('0'), ref1 = chr('9'); ref <= ref1 ? k <= ref1 : k >= ref1; ref <= ref1 ? k++ : k--){ results1.push(k); }
          return results1;
        }).apply(this));
        for (j = 0, len = ref4.length; j < len; j++) {
          cc = ref4[j];
          c = String.fromCharCode(cc);
          if (str.indexOf(c) > -1) {
            gr[c] = true;
          }
        }
      }
      if (str && str.length >= 2) {
        for (i = k = 0, ref5 = str.length - 3; (0 <= ref5 ? k < ref5 : k > ref5); i = 0 <= ref5 ? ++k : --k) {
          gr[str.substring(i, i + 2)] = true;
        }
      }
      if (str && str.length >= 3) {
        for (i = l = 0, ref6 = str.length - 2; (0 <= ref6 ? l < ref6 : l > ref6); i = 0 <= ref6 ? ++l : --l) {
          gr[str.substring(i, i + 3)] = true;
        }
      }
      return gr;
    };
    tokenize = function(query) {
      var ref;
      return _.map((ref = query.match(searchToken)) != null ? ref : [], normalize);
    };
    indexQuery = function(query) {
      var j, len, ref, token, tokens, tri;
      tri = {};
      tokens = {};
      ref = tokenize(query);
      for (j = 0, len = ref.length; j < len; j++) {
        token = ref[j];
        if (!tokens[token]) {
          tokens[token] = true;
          grams(token, tri);
        }
      }
      return {
        grams: tri,
        tokens: _.keys(tokens)
      };
    };
    addSearchDataFilter = function(data) {
      var updateEditors;
      updateEditors = _.throttle(function() {
        return data.trigger('updateSearch');
      });
      return data.addFilter({
        __proto__: basicDataFilter,
        clear: function(data) {
          return data.ftsIndex = {
            sizes: {},
            gramBlocks: {}
          };
        },
        replaceBlock: function(data, oldBlock, newBlock) {
          var gram, ref, ref1, ref2, ref3;
          for (gram in grams(oldBlock != null ? oldBlock.text : void 0)) {
            if ((ref = data.ftsIndex.gramBlocks[gram]) != null ? ref[oldBlock._id] : void 0) {
              if ((ref1 = data.ftsIndex.gramBlocks[gram]) != null) {
                delete ref1[oldBlock._id];
              }
              if (!--data.ftsIndex.sizes[gram]) {
                delete data.ftsIndex.gramBlocks[gram];
                delete data.ftsIndex.sizes[gram];
              }
            }
          }
          for (gram in grams(newBlock != null ? newBlock.text : void 0)) {
            if (!((ref2 = data.ftsIndex.gramBlocks[gram]) != null ? ref2[newBlock._id] : void 0)) {
              if (!data.ftsIndex.gramBlocks[gram]) {
                data.ftsIndex.gramBlocks[gram] = {};
                data.ftsIndex.sizes[gram] = 0;
              }
              if ((ref3 = data.ftsIndex.gramBlocks[gram]) != null) {
                ref3[newBlock._id] = true;
              }
              ++data.ftsIndex.sizes[gram];
            }
          }
          return setTimeout(updateEditors, 1);
        }
      });
    };
    searchForBlocks = function(data, query) {
      var blocks, count, counts, g, gram, gramBlocks, j, results, sizes, tokens;
      ({
        tokens,
        grams: g
      } = indexQuery(query));
      ({gramBlocks, sizes} = data.ftsIndex);
      counts = [];
      for (gram in g) {
        if (!sizes[gram]) {
          return [];
        } else {
          counts.push({
            gram: gram,
            size: sizes[gram]
          });
        }
      }
      if (counts.length) {
        counts.sort(function(a, b) {
          return b.size - a.size;
        });
        results = _.keys(gramBlocks[counts.pop().gram]);
        for (j = counts.length - 1; j >= 0; j += -1) {
          count = counts[j];
          blocks = gramBlocks[count.gram];
          results = _.filter(results, function(x) {
            return blocks[x];
          });
        }
        return _.filter(results, function(id) {
          var text;
          text = normalize(data.getBlock(id).text);
          return _.every(tokens, function(tok) {
            return text.search(tok) >= 0;
          });
        });
      } else {
        return [];
      }
    };
    SearchEditor = class SearchEditor extends OrgEditing {
      constructor(data, text1) {
        super(data);
        this.text = text1;
        this.data = data;
        this.results = {};
        this.addDataCallbacks({
          updateSearch: () => {
            return this.redisplay();
          }
        });
        this.setPrefix(`search-${editorCount++}-`);
      }

      checkValid() {
        if (!document.documentElement.contains($(this.editor.node)[0])) {
          this.cleanup();
          false;
        }
        return true;
      }

      initToolbar() {}

      setResults(newResults) {
        var changed;
        if (changed = !_.isEqual(newResults, this.results)) {
          this.results = newResults;
          this.rerenderAll();
        }
        return changed;
      }

      renderBlock(block) {
        var realBlock;
        realBlock = this.getBlock(block);
        if (this.shouldRender(realBlock)) {
          return super.renderBlock(realBlock);
        } else {
          return ['', realBlock != null ? realBlock.next : void 0];
        }
      }

      shouldRender(block) {
        while (block) {
          if (this.results[block._id]) {
            return true;
          }
          block = this.data.parent(block);
        }
        return false;
      }

      search() {
        var hits, results;
        if (hits = searchForBlocks(this.data, this.text.val())) {
          results = _.transform(hits, (function(obj, item) {
            return obj[item] = true;
          }), {});
          return this.setResults(results);
        }
      }

      redisplay() {
        return preserveSelection(() => {
          return this.search();
        });
      }

    };
    openSearch = function(event) {
      var editor;
      editor = editorForToolbar(event.originalEvent.srcElement);
      return withContext({
        editor: editor
      }, () => {
        $(editor.node).append(renderView('leisure-search'));
        return initializePendingViews();
      });
    };
    configureSearch = function(view) {
      var editor, input, opts, output, searchEditor;
      editor = UI.context.editor;
      output = $(view).find('.leisure-searchOutput');
      input = $(view).find('.leisure-searchText');
      output.parent().addClass('flat');
      searchEditor = new LeisureEditCore(output, new SearchEditor(editor.options.data, input).setMode(fancyMode));
      opts = searchEditor.options;
      Leisure.configureEmacsOpts(opts);
      Leisure.configurePeerOpts(opts);
      opts.data.openRegistration();
      opts.data.registerCollaborativeCode('doSlideValue', doSlideValue);
      opts.data.registerCollaborativeCode('viewBoundSet', function(context, name, data) {
        return options.setData(name, data);
      });
      opts.data.closeRegistration();
      opts.hiding = false;
      output.prev().filter('[data-view=leisure-toolbar]').remove();
      input.on('input', function(e) {
        return opts.search();
      });
      return opts;
    };
    Object.assign(Leisure, {openSearch, configureSearch, searchForBlocks});
    return {normalize, indexQuery, tokenize, addSearchDataFilter, grams, searchForBlocks, openSearch};
  });

}).call(this);

//# sourceMappingURL=search.js.map
